const key="er",D="default",root=document.documentElement,def={[D]:{data:{},col:{}}};let A=localStorage.getItem("current")||D,p=initProfile();function initProfile(){try{const e=JSON.parse(localStorage.getItem(key))??def;return e[D]={...def[D],...e[D]},localStorage.setItem(key,JSON.stringify(e)),e}catch(e){return console.error("Error initializing profile:",e),def}}const mgr={get:()=>p[A]||p[D],setCl(e,t){e&&(p[A]||(p[A]={data:{},col:{}}),t?p[A].data[e]=1:delete p[A].data[e],mgr.scheduleSave())},setCol(e,t){e&&(p[A]||(p[A]={data:{},col:{}}),p[A].col||(p[A].col={}),t?delete p[A].col[e]:p[A].col[e]=1,localStorage.setItem(key,JSON.stringify(p)))},setBatch(e){e?.length&&(p[A]||(p[A]={data:{},col:{}}),p[A].col||(p[A].col={}),e.forEach(({id:e,expanded:t})=>{e&&(t?delete p[A].col[e]:p[A].col[e]=1)}),localStorage.setItem(key,JSON.stringify(p)))},col(){return this.get().col||{}},saveTimer:null,scheduleSave(){clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>{localStorage.setItem(key,JSON.stringify(p))},100)}},checkboxMap=new WeakMap;let cachedCheckboxes=null,cachedTotalElements=null;function cacheCheckboxes(){cachedCheckboxes=document.querySelectorAll('input[type="checkbox"]'),cachedCheckboxes.forEach(e=>{checkboxMap.set(e,e.closest("li"))})}function restoreCheckboxes(){const{data:e}=mgr.get();cachedCheckboxes&&cachedCheckboxes.forEach(t=>{const a=!!e[t.id],o=checkboxMap.get(t);t.checked=a,o&&o.classList.toggle("c",a)})}function calculateTotals(){if(!cachedCheckboxes||0===cachedCheckboxes.length)return;if(!cachedTotalElements){const e=cachedCheckboxes[0].id.charAt(0),t=document.getElementById(`${e}-ot`);if(!t)return;const a=document.querySelectorAll(`span[id^="${e}-t"]`),o=new Map,c=new Map;Array.from(cachedCheckboxes).forEach(e=>{const t=e.id.match(/^[wdnqmbaerhskcp](\d+)-/)[1];o.has(t)||o.set(t,[]),o.get(t).push(e)}),a.forEach(t=>{const a=t.id.match(/t(\d+)$/)[1];c.set(a,document.getElementById(`${e}-nt${a}`))}),cachedTotalElements={totalAll:t,sectionSpans:Array.from(a),sectionMap:o,tocSpanMap:c}}const{totalAll:e,sectionSpans:t,sectionMap:a,tocSpanMap:o}=cachedTotalElements;let c=0,n=0;t.forEach(e=>{const t=e.id.match(/t(\d+)$/)[1],r=o.get(t),l=a.get(t)||[],s=l.filter(e=>e.checked).length,i=l.length,d=i?s===i?"DONE":`${s}/${i}`:"0/0",u=s===i&&i>0;[e,r].forEach(e=>{e&&(e.classList.remove("d"),e.textContent=d,u&&e.classList.add("d"))}),c+=s,n+=i}),e.classList.remove("d"),e.textContent=n?c===n?"DONE":`${c}/${n}`:"0/0",c===n&&n>0&&e.classList.add("d")}document.addEventListener("change",e=>{if(e.target.matches('input[type="checkbox"]')){const t=e.target,a=checkboxMap.get(t);a&&a.classList.toggle("c",t.checked),mgr.setCl(t.id,t.checked),calculateTotals()}}),window.addEventListener("pageshow",e=>{e.persisted&&window.location.reload()}),window.addEventListener("beforeunload",()=>{mgr.saveTimer&&(clearTimeout(mgr.saveTimer),localStorage.setItem(key,JSON.stringify(p)))}),document.addEventListener("DOMContentLoaded",()=>{cacheCheckboxes(),restoreCheckboxes(),calculateTotals(),window.addEventListener("storage",e=>{if(e.key===key||"current"===e.key)try{e.key===key?p=JSON.parse(e.newValue):"current"===e.key&&(A=e.newValue||D,l?.()),restoreCheckboxes(),calculateTotals()}catch(e){console.error("Error syncing profile:",e)}else if("h"===e.key){const t="1"===e.newValue;root.classList.toggle("hide",t),w&&w.setAttribute("aria-pressed",t?"true":"false")}});const e=document.querySelectorAll('a[href^="https"]');for(let t=0,a=e.length;t<a;t++){e[t].target="_blank"}const t=document.getElementById("theme");t&&(t.value=localStorage.getItem("t")||"l",t.addEventListener("change",()=>{const e="d"===t.value;root.classList.toggle("dark",e),localStorage.setItem("t",t.value)}));const a=document.getElementById("profile"),o=document.getElementById("add"),c=document.getElementById("edit"),n=document.getElementById("ngp"),r=document.getElementById("del");function l(){a&&(a.replaceChildren(),a.add(new Option("Default",D)),Object.keys(p).sort().filter(e=>e!==D).forEach(e=>a.add(new Option(e,e))),a.value=A)}l(),a?.addEventListener("change",()=>{const e=a.value||D;A=e,e===D?localStorage.removeItem("current"):localStorage.setItem("current",e),p[e]||(p[e]={data:{},col:{}})}),o?.addEventListener("click",()=>{const e=prompt("Enter a name for your profile:")?.trim();e&&("default"===e.toLowerCase()||p[e]?alert("default"===e.toLowerCase()?"Can't use default as the profile name.":"Profile already exists."):(p[e]={data:{},col:{}},A=e,localStorage.setItem(key,JSON.stringify(p)),localStorage.setItem("current",e),a.value=e,l()))}),c?.addEventListener("click",()=>{const e=a.value;if(e===D)return void alert("Can't edit the default profile.");const t=prompt(`Enter a new name for ${e}:`,e)?.trim();if(!t||t===e)return;if("default"===t.toLowerCase()||p[t])return void alert("default"===t.toLowerCase()?"Can't use default as the profile name.":"Profile already exists.");const o=p[e];delete p[e],p[t]=o,A=t,localStorage.setItem(key,JSON.stringify(p)),localStorage.setItem("current",t),l()}),n?.addEventListener("click",()=>{const e=a.value;if(!confirm(`Reset all progress in Walkthrough, DLC-Walkthrough, NPC-Walkthrough, Questlines, Bosses, and New Game Plus for ${e===D?"the default profile":e}?`))return;const t=["w","d","n","q","b","p"],o=Object.entries(p[e].data).reduce((e,[a,o])=>(t.includes(a.charAt(0))||(e[a]=o),e),{});p[e].data=o,localStorage.setItem(key,JSON.stringify(p))}),r?.addEventListener("click",()=>{const e=a.value;if(confirm(`Are you sure you want to ${e===D?"reset the default profile":"delete "+e}?`))if(e===D)p[D]={data:{},col:{}},localStorage.setItem(key,JSON.stringify(p));else{delete p[e],localStorage.setItem(key,JSON.stringify(p)),e===A&&(A=D,localStorage.removeItem("current"));const t=a.querySelector(`option[value="${e}"]`);t?.remove(),a.value=A}});const s=document.getElementById("imp-f"),i=document.getElementById("exp-f"),d=document.getElementById("imp-c"),u=document.getElementById("exp-c");function m(){return{current:A,[key]:p}}function f(e){if(!e?.[key]?.[D])throw new Error("Invalid profile data.");confirm("Importing a new profile will overwrite all current data.")&&(localStorage.setItem(key,JSON.stringify(e[key])),p=e[key],e.current&&(A=e.current,localStorage.setItem("current",A)),l(),alert("Successfully imported profile data."))}if(s){const e=document.createElement("input");e.type="file",e.accept=".json",e.style.display="none",s.after(e),s.addEventListener("click",()=>e.click()),e.addEventListener("change",async t=>{const a=t.target.files[0];if(a){try{const e=await a.text();f(JSON.parse(e))}catch(t){alert("Invalid profile data."),console.error(t)}e.value=""}})}i?.addEventListener("click",()=>{try{const e=new Blob([JSON.stringify(m(),null,2)],{type:"application/json"}),t=URL.createObjectURL(e),a=document.createElement("a");a.href=t,a.download="elden-ring-cheat-sheet.json",a.click(),URL.revokeObjectURL(t)}catch(e){alert("Error exporting file."),console.error(e)}}),d?.addEventListener("click",async()=>{try{const e=await navigator.clipboard.readText();f(JSON.parse(e))}catch(e){alert("Invalid clipboard data."),console.error(e)}}),u?.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(JSON.stringify(m(),null,2)),alert("Profile data copied to clipboard.")}catch(e){alert("Error copying to clipboard."),console.error(e)}});const g=document.getElementById("menu"),y=document.getElementById("sidebar"),h=y.querySelector(".close");function E(){"true"===y.ariaHidden?(y.ariaHidden="false",g.ariaExpanded="true",y.removeAttribute("inert")):(g.focus({preventScroll:!0}),y.ariaHidden="true",g.ariaExpanded="false",y.setAttribute("inert",""))}g.addEventListener("click",E),h.addEventListener("click",E),document.addEventListener("keydown",e=>{const t=document.activeElement;if(!("INPUT"===t.tagName||"TEXTAREA"===t.tagName||"SELECT"===t.tagName))switch(e.key.toLowerCase()){case"escape":"false"===y.ariaHidden&&E();break;case"q":e.ctrlKey||e.metaKey||(e.preventDefault(),E(),h.focus());break;case"/":if(!e.ctrlKey&&!e.metaKey){e.preventDefault();const t=document.getElementById("search");t&&t.focus()}break;case"h":if(!e.ctrlKey&&!e.metaKey){e.preventDefault();const t=document.getElementById("hide");t&&t.click()}}});const k=document.getElementById("up"),v=document.getElementById("scroll");if(k&&v){new IntersectionObserver(([e])=>{const t=!e.isIntersecting;k.classList.toggle("show",t),k.setAttribute("aria-hidden",t?"false":"true"),k.setAttribute("tabindex",t?"0":"-1")},{threshold:[0]}).observe(v),k.addEventListener("click",()=>{window.scrollTo({top:0}),g?.focus()})}const S=document.querySelectorAll(".col"),I=document.getElementById("exp-a"),L=document.getElementById("col-a"),b=new Map;for(const e of S){const t=e.getAttribute("aria-controls"),a=document.getElementById(t);if(!a)continue;b.set(e,a);const o=!!mgr.col()[t];e.ariaExpanded=!o,a.classList.toggle("f",o),e.addEventListener("click",()=>{const o="true"!==e.ariaExpanded;e.ariaExpanded=o,a.classList.toggle("f",!o),mgr.setCol(t,o)})}document.querySelector("style[data-c]")?.remove();const x=e=>{const t=[];b.forEach((a,o)=>{const c=o.getAttribute("aria-controls");o.ariaExpanded=e,a.classList.toggle("f",!e),t.push({id:c,expanded:e})}),mgr.setBatch(t)};I?.addEventListener("click",()=>x(!0)),L?.addEventListener("click",()=>x(!1));const w=document.getElementById("hide");if(w){const e="1"===localStorage.getItem("h");root.classList.toggle("hide",e),w.setAttribute("aria-pressed",e?"true":"false"),w.addEventListener("click",()=>{const e=!root.classList.contains("hide");root.classList.toggle("hide",e),localStorage.setItem("h",e?"1":"0"),w.setAttribute("aria-pressed",e?"true":"false")})}const C=document.getElementById("search");if(C){let e,t=null,a=null;C.addEventListener("input",o=>{clearTimeout(e),e=setTimeout(()=>function(e){const o=e.toLowerCase().trim();if(o===a)return;if(a=o,!t){const e=[...document.querySelectorAll("main h3")];t=e.map(e=>{const t=e.nextElementSibling;if(!t)return null;const a=e.textContent.toLowerCase();return{section:e,sectionText:a,itemData:[...t.children].map(e=>{const t=e.querySelector("ul"),a=t?[...t.querySelectorAll("li")]:[],o=e.textContent.toLowerCase(),c=a.map(e=>e.textContent.toLowerCase());return{item:e,nestedItems:a,mainText:o,nestedTexts:c}})}}).filter(Boolean)}if(!o)return void t.forEach(({section:e,itemData:t})=>{e.style.display="",t.forEach(({item:e,nestedItems:t})=>{e.style.display="",t.forEach(e=>e.style.display="")})});const c=o.split(/\s+/),n=e=>c.every(t=>e.includes(t));for(const{section:e,sectionText:a,itemData:o}of t){const t=n(a);let c=t;if(t)e.style.display="",o.forEach(({item:e,nestedItems:t})=>{e.style.display="",t.forEach(e=>e.style.display="")});else{for(const{item:e,nestedItems:t,mainText:a,nestedTexts:r}of o){let o=n(a);if(o)t.forEach(e=>e.style.display="");else for(let e=0;e<t.length;e++)n(r[e])?(t[e].style.display="",o=!0):t[e].style.display="none";e.style.display=o?"":"none",c||=o}e.style.display=c?"":"none"}}}(o.target.value),1)})}});